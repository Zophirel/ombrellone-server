# Beach Umbrella Booking Back-end

## Overview
This Express.js back-end application serves as the server-side component of the Ombrellone project. It works in conjunction with the [Ombrellone front-end](https://github.com/Zophirel/ombrellone-vue) 
to provide a full-featured beach umbrella booking system. The back-end handles user authentication, session management, booking management, payment processing via Stripe and PayPal, the data is stored using Mongo DB

## Features
- User Authentication
  - Login
  - Signup
  - Password Recovery
- Session Management
- Booking Management
  - Create and View Bookings
- Payment Integration
  - Stripe Payment
  - PayPal Payment
- MongoDB Integration

## Project Structure
```
.
|   .gitignore
|   app.js
|   auth_expetion.js
|   booking_excepiton.js
|   database.js
|   LICENSE
|   package-lock.json
|   package.json
|   token_exeption.js
|   
+---models
|       user.js
|       
+---payment
        paypal.js
        stripe.js
```

## Installation

1. **Clone the repository:**
 ```bash
 git clone https://github.com/Zophirel/ombrellone-server.git
 cd ombrellone-server
```
2. **Install dependencies:**
```
npm install
```
3. **Set up environment variables:** <br/>
Create a .env file in the root directory and add your environment variables for Stripe, PayPal, session management, and MongoDB.
```
NODE_SESSION_PASSWORD= ...
DBURI= ...
DBNAME= ...
STRIPE_KEY= ...
PAYPAL_CLIENT_ID= ...
PAYPAL_SECRET= ...
PAYPAL_API=https://api-m.sandbox.paypal.com
QR_KEY= ...
```
4. **Setup some mongodb db collection's schema** <br/>
Since the ombrellone project is not intended to be used by multiple beaches not everything is autmoated (yet) so i decided to insert some data manually / programmatically, down here you can find the code snippet to generate the needed data or an example of the schema that needs to be used
<details>
  <summary>beach</summary>
  <ul>
    <li>
      Schema
      <pre><code>
{
  _id: ObjectId(...)
  id: "4gZNmQXk" (random UUID)
  name: "Lido 1"
  places: 150
}
    </code></pre>
    </li>
    <li>
      Code
      <pre><code>
import { MongoClient, ServerApiVersion } from "mongodb";  
import ShortUniqueId from "short-unique-id";
const { randomUUID } = new ShortUniqueId({ length: 8 });
const client = new MongoClient(uri,  {
        serverApi: {
            version: ServerApiVersion.v1,
            strict: true,
            deprecationErrors: true,
        }
    }
);
async function insertBeach(){
    const db = client.db(process.env.DBNAME);
    const beaches = db.collection("beach");
    let beach = {
        id: randomUUID(),
        name: "Lido 1",
        places: places
    }
    beaches.insertOne(beach);
}
      </code></pre>
    </li>
  </ul>
</details>

<details>
  <summary>beach_places</summary>
  <ul>
    <li>
      Schema
      <pre><code>
{
  _id: ObjectId(...)
  id: "n5o7jl7j"
  beachId: "4gZNmQXk"
  row: "A"
  index: 1
}
reservations: Array (empty)
    </code></pre>
    </li>
    <li>
      Code
      <pre><code>
import { MongoClient, ServerApiVersion } from "mongodb";  
import ShortUniqueId from "short-unique-id";
const { randomUUID } = new ShortUniqueId({ length: 8 });
const client = new MongoClient(uri,  {
        serverApi: {
            version: ServerApiVersion.v1,
            strict: true,
            deprecationErrors: true,
        }
    }
);
// Adjust the for loop max iteration according to how many beach place you want totally (in this case is 150) 
// it is made by a 10 (rows from A to J) x 15 (columns from 1 to 15) grid, the number of columns can be modified
// by modifing the module ( j % 16 )
async function setPlaces(){   
    const db = client.db(DBNAME);
    const places = db.collection("beach_place");
    let j = 1;
    let filaCounter = 1;
    for(let i = 0; i < 150; i++){
        let place = {   
            id: randomUUID(),
            beachId: '4gZNmQXk',
            row: `${String.fromCharCode(64 + filaCounter)}`, // rows (A - J)
            index: j % 16, // columns (1 - 15)
            reservations: []
        }
        j++;
        if(j % 16 === 0){
            j++;
            filaCounter++;
        }
        places.insertOne(place);
    }
}
      </code></pre>
    </li>
  </ul>
</details>

<details>
  <summary>beach_place_reservation</summary>
  <ul>
    <li>
      Schema
      <pre><code>
//this is generated by the server when the client request a new reservation so there is no need to define it ahead
{
  "_id": ObjectId(...),
  "id": "43GWzTBR7u",
  "beachId": "4gZNmQXk",
  "userId": "FpUwBma2",
  "userName": "Luigi",
  "userSurname": "Verdi",
  "date": "2024-06-10T22:00:00.000Z",
  "added": "2024-06-11T20:30:58.873Z",
  "placeRow": "J",
  "placeIndex": 1,
  "chairs": 1,
  "price": 10,
  "qrData": "..." // this is rapresent the reseravation in an encrypted form (the encryption used can be found in the database.js file)
}
    </code></pre>
    </li>
  </ul>
</details>

<details>
  <summary>user</summary>
  <ul>
    <li>
      Schema
      <pre><code>
//this is generated by the server when the client hit the /signup endpoint so there is no need to define it ahead
{
  "_id": ObjectId(...),
  "id": "FpUwBma2",
  "name": "Luigi",
  "surname": "Verdi",
  "email": "blo@blo.com",
  "password": "...", // hashed using bcrypt
  "tel": "3500000000",
  "change_password_token": {
    "token": null,
    "expireDate": null
  }
}
    </code></pre>
    </li>
  </ul>
</details>


5. **Run the project:**
```
npm run app
```